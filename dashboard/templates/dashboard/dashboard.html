{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Dashboard ‚Ä¢ Dynamic Dashboard AI{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'dashboard/css/dashboard.css' %}">
{% endblock %}

{% block content %}

<div id="dashboard-container">
    
    <!-- HEADER WITH MODERN DESIGN -->
    <header class="dashboard-header">
        <div class="header-content">
            <div class="header-top">
                <h1 class="page-title">Dynamic Dashboard</h1>
            </div>
            <p class="subtitle">Real-time market insights with AI-powered analytics</p>
            <div class="header-stats">
                <div class="stat-badge">
                    <div class="stat-icon">üìä</div>
                    <div class="stat-info">
                        <div class="stat-value" id="total-records">{{ chart_data.dates|length }}</div>
                        <div class="stat-label">Total Records</div>
                    </div>
                </div>
                <div class="stat-badge">
                    <div class="stat-icon">üïê</div>
                    <div class="stat-info">
                        <div class="stat-value" id="last-updated">Just now</div>
                        <div class="stat-label">Last Updated</div>
                    </div>
                </div>
                <div class="stat-badge">
                    <div class="stat-icon">üìà</div>
                    <div class="stat-info">
                        <div class="stat-value" id="charts-active">3</div>
                        <div class="stat-label">Active Charts</div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT GRID -->
    <main class="dashboard-main">
        
        <!-- COMPACT 6 CARDS IN ONE ROW -->
        <section class="compact-section">
            <div class="section-header">
                <h2 class="section-title">
                    <span class="title-icon">üìà</span>
                    Market Overview & Daily Changes
                </h2>
            </div>
            <div class="compact-row">
                <!-- Gold KPI -->
                <div class="compact-card kpi gold">
                    <div class="compact-card-inner">
                        <div class="compact-icon">ü•á</div>
                        <div class="compact-content">
                            <h4 class="compact-label">Gold</h4>
                            <div class="compact-main-value" id="kpi-gold">--</div>
                            <div class="compact-date" id="kpi-date">--</div>
                        </div>
                    </div>
                </div>

                <!-- Gold Change -->
                <div class="compact-card change gold">
                    <div class="compact-card-inner">
                        <div class="compact-icon">üìà</div>
                        <div class="compact-content">
                            <h4 class="compact-label">24H Change</h4>
                            <div class="compact-value" id="change-gold">--</div>
                            <div class="compact-sublabel">vs Previous</div>
                        </div>
                    </div>
                </div>

                <!-- Silver KPI -->
                <div class="compact-card kpi silver">
                    <div class="compact-card-inner">
                        <div class="compact-icon">ü•à</div>
                        <div class="compact-content">
                            <h4 class="compact-label">Silver</h4>
                            <div class="compact-main-value" id="kpi-silver">--</div>
                            <div class="compact-date" id="kpi-date-2">--</div>
                        </div>
                    </div>
                </div>

                <!-- Silver Change -->
                <div class="compact-card change silver">
                    <div class="compact-card-inner">
                        <div class="compact-icon">üìà</div>
                        <div class="compact-content">
                            <h4 class="compact-label">24H Change</h4>
                            <div class="compact-value" id="change-silver">--</div>
                            <div class="compact-sublabel">vs Previous</div>
                        </div>
                    </div>
                </div>

                <!-- Oil KPI -->
                <div class="compact-card kpi oil">
                    <div class="compact-card-inner">
                        <div class="compact-icon">üõ¢Ô∏è</div>
                        <div class="compact-content">
                            <h4 class="compact-label">Oil</h4>
                            <div class="compact-main-value" id="kpi-oil">--</div>
                            <div class="compact-date" id="kpi-date-3">--</div>
                        </div>
                    </div>
                </div>

                <!-- Oil Change -->
                <div class="compact-card change oil">
                    <div class="compact-card-inner">
                        <div class="compact-icon">üìà</div>
                        <div class="compact-content">
                            <h4 class="compact-label">24H Change</h4>
                            <div class="compact-value" id="change-oil">--</div>
                            <div class="compact-sublabel">vs Previous</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- COMPARISON CHARTS -->
        <section class="chart-section">
            <div class="chart-comparison">
                <div class="chart-container bar-chart">
                    <div class="chart-header">
                        <h3 class="chart-title">
                            <span class="chart-title-icon">üìä</span>
                            Latest Price Comparison
                        </h3>
                    </div>
                    <div class="chart-body">
                        <canvas id="bar-chart"></canvas>
                    </div>
                    <div class="chart-footer">
                        <div class="chart-legend">
                            <div class="legend-item gold">
                                <span class="legend-dot"></span>
                                <span class="legend-label">Gold</span>
                            </div>
                            <div class="legend-item silver">
                                <span class="legend-dot"></span>
                                <span class="legend-label">Silver</span>
                            </div>
                            <div class="legend-item oil">
                                <span class="legend-dot"></span>
                                <span class="legend-label">Oil</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="chart-container pie-chart">
                    <div class="chart-header">
                        <h3 class="chart-title">
                            <span class="chart-title-icon">üìà</span>
                            Price Distribution
                        </h3>
                    </div>
                    <div class="chart-body">
                        <canvas id="pie-chart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- PRICE TRENDS - 3 VERTICAL CHARTS -->
        <section class="trends-section">
            <div class="section-header">
                <h2 class="section-title">
                    <span class="title-icon">üìà</span>
                    Price Trends
                </h2>
            </div>
            <div class="trends-vertical">
                <!-- Gold Trend -->
                <div class="trend-item">
                    <div class="trend-chart-header">
                        <div class="trend-title-group">
                            <div class="trend-icon">ü•á</div>
                            <div>
                                <h4 class="trend-title">Gold Price Trend</h4>
                                <span class="trend-period">Last 30 days</span>
                            </div>
                        </div>
                        <div class="trend-current" id="trend-current-gold">--</div>
                    </div>
                    <div class="trend-chart-wrapper">
                        <canvas id="chart-1"></canvas>
                    </div>
                </div>

                <!-- Silver Trend -->
                <div class="trend-item">
                    <div class="trend-chart-header">
                        <div class="trend-title-group">
                            <div class="trend-icon">ü•à</div>
                            <div>
                                <h4 class="trend-title">Silver Price Trend</h4>
                                <span class="trend-period">Last 30 days</span>
                            </div>
                        </div>
                        <div class="trend-current" id="trend-current-silver">--</div>
                    </div>
                    <div class="trend-chart-wrapper">
                        <canvas id="chart-2"></canvas>
                    </div>
                </div>

                <!-- Oil Trend -->
                <div class="trend-item">
                    <div class="trend-chart-header">
                        <div class="trend-title-group">
                            <div class="trend-icon">üõ¢Ô∏è</div>
                            <div>
                                <h4 class="trend-title">Oil Price Trend</h4>
                                <span class="trend-period">Last 30 days</span>
                            </div>
                        </div>
                        <div class="trend-current" id="trend-current-oil">--</div>
                    </div>
                    <div class="trend-chart-wrapper">
                        <canvas id="chart-3"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- ACTION BUTTONS -->
        <div class="action-section">
            <button id="saveSnapshotBtn" class="snapshot-btn">
                <span class="btn-icon">üì∏</span>
                <span class="btn-text">Save Dashboard Snapshot</span>
                <span class="btn-subtext">Export as PNG</span>
            </button>
        </div>

        <!-- AI ASSISTANT -->
        <section class="ai-section" id="ai-section">
            <div class="ai-container" data-snapshot-id="{{ latest_snapshot_id|default:'' }}">
                <div class="ai-header">
                    <div class="ai-header-left">
                        <div class="ai-icon">ü§ñ</div>
                        <div class="ai-title">
                            <h3>AI Dashboard Assistant</h3>
                            <p class="ai-subtitle">Ask questions about trends and insights</p>
                        </div>
                    </div>
                    <div class="ai-header-right">
                        <div class="ai-status online">
                            <span class="status-dot"></span>
                            <span class="status-text">Online</span>
                        </div>
                    </div>
                </div>
                
                <div class="ai-body">
                    <div class="ai-media">
                        <div class="ai-media-header">
                            <div class="ai-media-title">AI Analysis (llava)</div>
                            <div class="ai-media-subtitle">Snapshot preview</div>
                        </div>
                        <div class="ai-media-frame" id="ai-media-frame">
                            {% if latest_snapshot_url %}
                                <img src="{{ latest_snapshot_url }}?v={{ latest_snapshot_id|default:'' }}" alt="" class="ai-media-image" id="ai-media-image" />
                            {% else %}
                                <div class="ai-media-empty" id="ai-media-empty">
                                    <div class="ai-media-empty-title">No snapshot available</div>
                                    <div class="ai-media-empty-text">Save a dashboard snapshot to enable visual analysis.</div>
                                </div>
                            {% endif %}
                        </div>
                        {% if latest_snapshot_created %}
                            <div class="ai-media-meta" id="ai-media-meta">Last captured: {{ latest_snapshot_created }}</div>
                        {% endif %}
                    </div>
                    <div class="ai-input-group">
                        <input type="text" 
                               placeholder="Example: What's the correlation between gold and oil prices?" 
                               id="ai-question"
                               class="ai-input"/>
                        <button id="ask-ai-btn" class="ai-btn">
                            <span class="btn-text">Ask AI</span>
                            <span class="btn-arrow">‚Üí</span>
                        </button>
                    </div>
                    
                    <div id="ai-answer" class="ai-answer">
                        <div class="ai-placeholder">
                            <div class="placeholder-icon">üí°</div>
                            <div class="placeholder-content">
                                <h4>Ready to help!</h4>
                                <p>Ask a question to analyze the latest dashboard snapshot.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </main>

</div> <!-- END dashboard-container -->

<form id="csrf-form" style="display: none;">
    {% csrf_token %}
</form>

<!-- Pass chart_data to JS -->
<script>
    const chartData = {{ chart_data|safe }};
</script>

<!-- Chart.js & html2canvas CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="{% static 'dashboard/js/chart_manager.js' %}"></script>
<script src="{% static 'dashboard/js/vlm_interface.js' %}"></script>

{% endblock %}